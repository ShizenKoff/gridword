/*

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@#::::::::::=@@@%::::%@@@@@@%::::::::::::%@@@@@@@@@#:::=%@@@@@#:::@@@@#::::::::::%%#:::+@@@@@@@@%:::+@@@=:::*@@@@@@@@@@@@%:::*@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@#:::::::::::%@@@%=:::::@@@@@@#:::::::::::::#@@@@@@@@#:::::%@@@@#:::@%#::::::::::::::%+:::%@@@@@@%:::=%@%+:::::%@@@@@@@@@@@%:::+@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@*:::%@@@@@@@@@@%+::::::-%@@@@#:::#%%%%%%=::*@@@@@@@@#::::::#%%%#:::@%+:::#%%%%%%#:::#%=:::%@@@@%=:::%%%*:::::::%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@+::=%@@@@@@@@@%#:::*%:::+%@@@#:::#%%%#**:::*%%#####@#:::+:::+%%*:::%%+:::%@@@@@%%:::#%%::::%%%%*:::%%%#:::+%:::-%@@@@@@@@@%:::+@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@+::=%@@@@@@@@%#:::*%%#:::+%@%#:::#%=:::::::#@*::::-%#:::%%::::%*:::%%+:::%@@@@@@%:::#%%%:::-%%*:::*%%%:::-%%%:::+@@@@@@@@@%:::+@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@+::=%@@@@@@@@%:::=%#::::::%%%#:::#%#::::%%%@@@%%%%%@#:::%%%-:::+:::%%+:::%@@@@@%%:::#%@%#:::=%:::=%%%::::%#::::::*@@@@@@@@%:::+@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@+:::%%@@@@@@%:::=%#::::::::%%#:::#@@%-:::*%@@@@@@@@@#:::%%%%+::::::@%+:::#%%%%%%#:::#@@@%*::::::-%%%-:::%%::::::::%@@@@@@@%:::+@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@%:::::::::*%-:::%@@@@%%%::::%#:::%@@@%*:::=%@@@@@@@@#:::%@@@%#:::::@@%:::::::::::::=%@@@@%=:::::%@%*:::#@@@%%%%+:::%@*:::%%:::+@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@#::::::*%*::-%@@@@@@@@%:::+#:::%@@@@@%:::=@@@@@@@@#:::%@@@@@%:::-@@@@#:::::::::-%@@@@@@@@-:::@@@%:::*@@@@@@@@@-::=@*:::%@-::*@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%@@@@@%%%%@@@@%%%%@@@@@%%%%@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%@@@%%%%%@@@@%%%%%@@@%%%%%@@@@%%@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%%%%%%%%%%%%%%%%%@@%%%%@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%@@%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@@@@%%%%@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@@@@@%%@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%@%%%%%%%%%%%%%%%%%%%#%%%%%%%%%%%%%%@@%%%%@@@@@%%%@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%%%%%%%%%%%%%%%%%#%%%%%%%%%%%%%%%%%%%%@@@@@%%%@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%@@@@%%%%%%%%%%%%%%%%%%###*#%%%%%%%%%%%%%%%%%%%%%%%@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%@@%%%%%%%%%%%%%%%%%%%####+##%%%%%%%%%%%%%%%%%%%%%%@@@@@%@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@@@@%%%%%%%%%%%%%%%%%########+*####%%%%%%%%%%%%%%%%%%@%%%%@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%@@@@%%%%%%%%%%%%%%%%########*=*########%%%%%%%%%%%%%%%%%%%@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%%%%%%%%%%%#########**+-+*########%%%%%%%%%%%%%%%%%%@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@@@%%%%%%%%%%%%%%%%%#########***+:+***#######%%%%%%%%%%%%%%%@@@%%%@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@@@@%%%%%%%%%%%%%%##########****+=:=+****########%%%%%%%%%%%%@@%%%@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%%%%%%%%########*****++=-:-=+****#########%%%%%%%%%%%%%@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%%%%%%%%####********+++==-::==++*****##**###%%%%%%%%%%%%@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%@@%%%%%%%%%%%######**=+++++++==-:::-==+++***++*###%%%%%%%%%%%@%%%%@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%@%%%%%%%%%%%#######***+--====--:::::--====--+**####%%%%%%%%%%%%%%%@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%%%%%%######****++=::--:::::::::-:::=++**######%%%%%%%%%%%@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%%%%######****++==-:::::::::::::::-=++***######%%%%%%%%%@@@@%%%%
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@@%%%%%%%%%%%######****+++==--:::::::::::::::--==++****####%%%%%%%%%%@@%@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%#####****+++==--:::::::::::::::::::::::::::--==+++***#####%%%%%@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%@@@@@%%%%@@@@@%@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%%%%######****+++==--:::::::::::::::::::--==++***#####%%%%%%%%%%@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%%%%%%%@@%%%%@@@@@%@@@@@@@@@@@@@@@@@%%@@@%%%%%%%%%%%%######****+++==--::::::::::::::-==+++**######%%%%%%%%%@@@%%@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%@@@%%%%%%%%%%%%%%%%%%%%%%%@@@@%%%@@@@@@@@@@@@@@@%%@@@@%%%%%%%%%%%%%######****++==-:::::::::::::-==++***######%%%%%%%%%@@@@%%@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%#++======+*####%%%%%%%%%%@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%%%%%%%%######****++=::--::::::::-::-++***####%%%%%%%%%%%%%%%@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%*=:=+++++++===---::::+##%%%%%%@@@@%%@@@@@@@@@@@@@@@%%%%@@%%%%%%%%%%%%######***+--====--::::-==++=:+*#####%%%%%%%%%%%@%%%%@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%-+###########***+++==---::::*#%%%%%%@@@@@@@@@@@@@@@@@@@%%@@@%%%%%%%%%%%%%#####**==+++++==-:::-=+++****=####%%%%%%%%%%%%%%%%%@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%=+#################****++=--:::::+#%%%%%@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%%%%%%%%####***+=::=+++=-::=++****######%%%%%%%%%%%%%%%@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%=*#%##########**########***++=--:::::*#%%%%@@@@@@@@@@@@@@@@@@@@%%%%@%%%%%%%%%%%%####**=:::++*++-:-++**#######%%%%%%%%%%%%%%%%%@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%*+##%%%%%%%%%%%%%%%#+*#######**+=--:::::-#%%%%%@@@@@@@@@@@@@@@@%@@@@@%%%%%%%%%%%%#####*=--:+****+=:=+**#####%%%%%%%%%%%%%%%%@@@@%%%@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%+##%%%%%%%%%%%%%%%%%%%%*=#######*++=-::::::##%%%@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%%%%%%###==:-*******+:+*######%%%%%%%%%%%%%%%%%@@@@%%%@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%-#%%%%%%%%%%%%%%%%%%%%%%%%*-######*=-+++==:::*%%%%%@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%%##+**++*####**+-+*###%%%%%%%%%%%%%%%%%@@%%%%@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@%%+#%%%%%@@@@%%*+**++=-=%%%%%%%=#####-##**+===-:+%%%%%%@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%%##-==-*######**=*###%%%%%%%%%%%%%%%%@@@@%%%%@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@%%#+#%%%%@@@@%#%%%%**#%#+--#%%%%%+#%##=##*+::::::-#%%%%@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%%#-++:=*##*+-+**=*##%%%%%%%%%%%%%%%%%%%%%@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@%%=##%%%%@@@%%%#=#%%%%*:*#=-=%%%%%+#%#*+**=:::::::=#%%%@@@@@@@@@@@@@@@@@@@@%%%%@@@%%%%%%%#-++-***+---:++=*##%%%%%%%%%%%%%@@@@%%%%@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@%%%-#%%%@@@@%%%+#%@@%%%%%*-#+-*%%%%%*%%#*=*+-:::::::-#%%%@@@@@@@@@@@@@@@@@@@@%%%@@%%%%%%%#*-===+-+:---:-::+##%%%%%%%%%%%%%@@@@%%%%@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@%%%#=#%%%@@@@%@*%%@@@@@@@%%#+%=-%%%%%%#%%##*--=-::-:::=%%%%@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%*+***+##===--=+-==-#%%%%%%%%%@@@@%%%%@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@%@%%-##%%@@@@%@*@@@@@@@@@@%%*%*=%%%%%%%%%%###*+-:::::::*%%%%@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%=*#####++++-*##*++-+#%%%%%%%%@@@@%%%%@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@%%%=*%%%@@@@%@#%@@@@@@@@@%%#%*=%%%%%%%%%%%%###**+=--::=%%%@@@@@@@@@@@@@@@@@@@@@%@@@@%%%%%=*#####+##*+#***++=:#%%%%@@@@%%%%@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@%%%=%%%%@@@@%@%%@@@@@@@@%#%%*%%%%%%%%%%%%%%%###*+=-::=%%%@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%+*##**+#**+%%%%+#*-:*%%%%@@@@%%%%@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@%%**%%%%%@@@%@@#%@@@@%#%%%##%@@@%%%%%%%%%%%%##**+=-:=#%%%@@@@@@@@@@@@@@@@@@@@@@@@%@%%%%*+###+##%++%%%%%+#+#%%%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%#+%%%%%%@%%%%@@@@@@%%##%@%%@@@@%%%%%%%%%%%##*+=-:+%%%%@@@@@@@@@@@@@@@@@@@@@%%%%@@%%%%=##=#%%%#**%%%%%#*%%%%@@%%%@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%#=#%%%%%%@@%%%%%%%%%@@@@@%%@@@@%%%%%%%%%%##*+=-:+%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%+##+#%%%#+*%%%%%%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@%%%*=#%%%%%@@@@@@@@@@@@@@@@@%@@%%%%%%%%%%%%##*=-:*%%@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%+*##%%%%#+*%%%%%@@@@%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%*:*#%%%%%@@@@@@@@@@@@@@@*%%%%%%%%%%#%%##*=-:#%%@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%*=#%%%%#*=%%%%%%@@@@%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%#+-=*#%%%@@@@@@@@@@@@@%%#+++*#%#####**=--%%%%@@@@@@@@@@@@@@@@@@@@@@@@%%@@%%%%%#*=*#*=*%%%%@@%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%@@@%%%%%%#+#%%@@@@@@@@@@@@@@%%%%%%%%#**++=-:-#%%%%@@@@@@@@@@@@@@@@@@@@@@@@%%@@%%%%=+#%%%%#:*%%%@@@%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%=*%%@@@@@@%@@@@@%%%%#=#%%%%%%####%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%#-++*##*+:+%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%@@@%%*=#%%%%@@@@%@@@%%%#*=%%%%%%%%%%%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%-+#%%%%#*:#%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%@@%%%#=#%%@@@@@@@#%%%%%*==%%%%%%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%+-*#%%%%#*:%%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%@@@@@%%%%%%-##%%%@@@@@%#%%%#*-+%%%%@@@%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%#-*#%%%%%#+=%%%@@@@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%@@%%%%%%%*+*##%%@@@@@%%#%%%#*-*%%%%@@@%%%%%@@@@%@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%+=##%%%%%#++%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@@@%%%%%#*==+**##%%%%%%%%%%*%##*-*%%%%%%%%%%@@%%%@@@@@@@@@@@@@@@@@@@@@@@@@%@@@%%%*-*##%%%%%*=*%%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%#+-*##%%%%%%%%%%#+#%%%%%#%#*=+%%%%%%%%%%%%%%%%@@@@@@@@@@@@@@@@@@@@@@%%%@%%%%#-*##%%%%%%*-#%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%*=*#%%%%%%%%%%%%%%%%%#*-#%%###*=*=#%%%%%%%%%%%@@%%@@@@@@@@@@@@@@@@@@@@@@@@%%%%-+##*%%%%%#*:%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@%%@%%%%+*#%%%%%%%%%%%%%%%%%%%%####+=+###*%%#+:*###%%%%%%%%%%%@@@@@@@@@@@@@@@@@@@@@%%%%+=*##%%%%%%#+=%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@%%%%%*+********#%%%%%%%%%%%%%#####**++-=+####*:::-=*#%%%%%%%%@@@@@@@@@@@@@@@@@@@%%%%%*-*#%#%%%%%%#-#%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@%@@%%%%+-+*########*==#%%%%##%%#####***++===--:::::::-==:=*#%%%%%%%%@@@@@@%%@@@@@%%%%%%#=*#%##%%%%%%*-%%%@%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@%%%++*#%%%%%%%%###**+:*%%%%*######***+++==-----::::::+*+=:-#%%%%%%%@@@@%%@@@@@@%%%%%%-*#%%#%%%%%%#*=%%%@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@%%#=*###%%%%%#*#####*++=:%%%%#*#####***+++===-----:::::+***+-:*#%%%%%%%%@@@@%%%%@%%%%=*#%%#%%%%%%%#++%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@%%*=*#%%%@@@@@%%%#+###*++=:#%%%%*#####***+++===------::::=###*+=:*##%%%%%%%%%%%%%%%%%*+#%%#%%%%%%%%*-#%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@%%%%#=*#%%@@@@@@@@@%%%**#**+==:#%%%#*#####****+++===-----::::=###*===-::=+*##%%%%%%%%%%%=##%#%%%%%%%%#*:%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@%%%%***%%@@@@@@@@@@@%%%#*#**+===%%%%########****++====------::+##*##**++===-:::=**#%%%%%*#%#%%%%%%%%%#=*%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@%%+*%%%@@@@@@@@@@@@%%%+###**+=%%%%%#%#######***+++====------:#%%%%%%###***+++===--:-##%#*%%%%%%%%%%*=%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@%%=*%%@@@@@@@@@@@@@@%%*#####*+%%%%%#%%%%#####****+++====-----:#%%%%%%%%%%######****+++##%%%%%%%%%%#+*%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@%%+*%%@@@@@@@@@@@@@@%%*%%%%#*+%%%%%%%%%%%####****++++====-----+%%%%%%%%%%%%%%%%%%####**%#%%%%%%%%%*=%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@%%%%**#%%@@@@@@@@@@@@@%#%%%%%#*#%%@@@%%%%%%%%#***+++=++-=--::-:-:#%%%%%%%%%%%%%%%%%%%%%%+%%%%%%%%%%#*%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@%%%%#+##%@@@@@@@@@@@@@#%%%%%%*#%%@@@@%%%%%%%%%#####****+++=====-:+%%%%%%%%%%#%%%%%%%%%%%*%%%%%%#%%*+%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@%%#+%%%@@@@@@@@@@%%%%%%+#%%%@@@@@@%@@@%%%%%%%%#####****+++====:%%%%%%%%%%%%%%%%%%%%%%*%%%%%%%%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@%%%*%%@@@@%%%%%@@@%%%%@@@@@@@@@@@@@@@@%%%%%%%%%%####****+++==:#%%%%%%%%%%%%%%%%%%%%##%#%%%#*%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@%@%%%##%%@@@@@@@%%%%%%%%#%@@@@@@@@@@@@@@@%%%%%%%%%#####****++=-+********####%%%%%%##*%##***%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@%%@%%+%%@@%%%%%%@@@%%**%#+%@@@@@@@@@@@@@@@@%%%%%%%%%%#####***++-*%%%%%%%%%%%%%%%%###%%%%%%%%%%@@@@@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@%%%##%%%%@@@@@@@@%%%%%%#*%@@@@@@@@@@@@@@@@@@%%%%%%%%%###****++-*%%%%%%%%%%%%%%%%%%%%%@@@@@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@%%+%%@@@@@@@@@@#%%%%%#+%@@@@@@@@@@@@@@@@@@@@%%%%%%#++*###**+=-#%%%%%%%%@@@@@%%%%@@@@%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@%#*%%@@@@@@@@@%#%%%%##*%@@@@@@@@@@@@@@@@@@@%%%%#+#%%%%%%%%%%*-%%%@@%%%%@@@@@%%%@@@@@%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@%%%%*#%@@@@@@@@@@%%%%%%#*#%@@@@@@@@@@@@@@@@@@@%%%*%%%%%%%%%%%%%=%%%%%%@@@@@%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@%%%%%+%%@@@@@@@@@@%%%%%##+%@@@@@@@@@@@@@@@@@@@%%#%%@@%%%%%%%%#**#%%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@%%*%%@@@@@@@@@%%%%%%#*#%@@@@@@@@@@@@@@@@@@@%#%@@%%%%%%%%%#++%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@%%#%%@@@@@@@@@%%%%%%#*%%%@@@@@@@@@@@@@@@@%#%@@@@@%%%%%%%#*-#%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@%%##%%@@@@@@@@@%%%%%#**#%%%%@@@@@@@@@@@@%%%@@@@@%%%%%%%%##+=%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@%%%%##%%@@@@@@@@%%%%%%#*%%*#%%%%@@@@@@@%%%@@@@@@@%%%%%%%%#*+=#%%%@@%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@%%%%##%%@@@@@@@@%%%%%%*%%%%##%#%%%%%%%@@@@@@@@@@%%%%%%%%%%#*+%%%%@@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@%@@@%%#%%%@@@@@@@%%%%%%##%%%%%#%%%%%%@@@@@@@@@@@@%%%%%%%%%%%#*#%%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@%%%@@@%%#%%%@@@@@@@%%%%%%*%%%%%%%#%%%%%%@@@@@%@@@@@%%%%%%%%%%##+%%%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@%%%%#%%%%%%@%%%%%%%%#%%%%%%%%%#%%%%%%%%@@@%%%%%%%%%%%%%%%#*#%%%%@@@%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#%%%%%%%%%%%%%%%%%%%%%%%%%%%##%%%%@@@@%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%##%%%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@%@@@%%#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#%%%%%%%%%@@@@@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@@@@%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@@@@%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
*/

// ------------------------------------------------------------
// GRIDWORD â€“ Core Game Script
// Version: 1.2.0 â€“ "Operation GridWord Polish"
// Owner: Carson Design & Prototyping â€“ Interactive (CAR-NOVA.i)
//
// ARCHITECTURE
//  - CONFIG & CONSTANTS
//  - GLOBAL STATE
//  - DOM REFERENCES
//  - INIT & BOOTSTRAP
//  - RENDERING (GRID / UI)
//  - INPUT HANDLING (Keyboard / Pointer / Touch)
//  - GAME LOGIC (Validation, Scoring, End-of-Puzzle)
//  - AUDIO & FX (Sounds, Micro-Animations)
//  - DAILY MODE (Optional v1.2 feature)
//  - PLATFORM INTEGRATION (FB Instant, etc.)
//  - UTILITIES
//
// NOTE TO FUTURE CARSON & NOVA:
//  - Only edit inside the clearly marked sections.
//  - When NOVA sends updates, they will reference the
//    [NOVA-SECTION: ...] tags below for safe copy/paste.
// ------------------------------------------------------------

'use strict';


// ============================================================
// #region CONFIG & CONSTANTS
// >>> [NOVA-SECTION: CONFIG & CONSTANTS â€“ START]
// ============================================================

/**
 * Global configuration values that rarely change at runtime.
 * Puzzle dimensions, colors, animation timings, etc.
 */

 // ------------------------Share code------------------------
  const GW_SHARE_URL = 'https://carson-designs.com/gridword'; // <-- set this to your live game URL

// ------------------------------------------------------------ VERSION NUMBER ----------------------------------------------------------------
const GW_VERSION = '1.2.2';

// Core puzzle config for the current GridWord mode
const GRID_SIZE = 5;  // 5x5 interlocking grid

// Difficulty â†’ % of letters auto-revealed as given cells
const DIFF_HINTS = {
  easy:   0.55,
  normal: 0.33,
  hard:   0.18,
};

// Optional "meta" config if we expand visuals/FX later
const GW_CONFIG = {
  anim: {
    tileInputMs: 120,
    rowSolveMs: 220,
    shakeMs: 180,
  },
  audio: {
    enabledByDefault: true,
    musicVolume: 0.4,
    hintPenaltyMs: 10_000, // +10s per hint
  },
  files: {
    puzzles: 'data/puzzles/generated_puzzles.json',
    dictionary: 'data/dicts/dict_3to5.json'
  },
  storageKeys: {
    bestPrefix: 'gridlocked_best_',      // + difficulty
    diff: 'gridlocked_diff',
    audioEnabled: 'gw_audio_enabled'
  }
  // TODO: add more config as needed (colors, fonts, layout thresholdsâ€¦)


};

// <<< [NOVA-SECTION: CONFIG & CONSTANTS â€“ END]
// #endregion
// ============================================================

// Active puzzle solution + input refs for hint/check logic
let currentSolutionGrid = null;  // 2D array of solution letters / '-'
let currentInputs = null;        // 2D array of <input|null>

let PUZZLES = [];            // loaded puzzle bank
let shareBtn = null;

let bgm;   // reference to <audio id="bgm">
let bgmStarted = false;
let bgmMuted = false;



// ============================================================
// #region GLOBAL STATE
// >>> [NOVA-SECTION: GLOBAL STATE â€“ START]
// ============================================================

/**
 * All mutable runtime state lives here.
 * No random globals scattered around â€“ keep it centralized.
 */

const gwState = {
  // Puzzle data
  puzzles: [],               // loaded from generated_puzzles.json
  wordSet: null,             // dictionary Set<string> or empty Set

  // performance.now() when puzzle starts

  // Interlocking grid state
  currentSolutionGrid: null, // 2D array of letters/'-'
  currentInputs: null,       // 2D array of <input|null>
  currentDifficulty: localStorage.getItem(GW_CONFIG.storageKeys.diff) || 'normal',

  // Typing direction for auto advance
  // Default: 'horizontal' (right), alternative: 'vertical' (down)
  advanceDir: {dr: 0, dc: 1},

  // Timer
  timerId: null,
  startTime: null,           // performance.now() when puzzle starts

  // Status
  isReady: false,
  isSolved: false,
  isLocked: false,

  // Stats
  lastElapsedMs: 0,

  // Audio / platform
  audioEnabled: true,
  platformReady: false,
  fbContext: null,

    // Daily mode
  isDaily: false,
  dailyKey: null,       // e.g. "2025-11-16"
  dailyStreak: 0,

  lastResult: null,        // 'solved' | 'failed' | null
};

// <<< [NOVA-SECTION: GLOBAL STATE â€“ END]
// #endregion
// ============================================================



// ============================================================
// #region DOM REFERENCES
// >>> [NOVA-SECTION: DOM REFERENCES â€“ START]
// ============================================================

/**
 * Cache references to DOM elements so we don't keep querying.
 * Note: most of the UI for GridWord is created dynamically inside #app.
 */

const gwDom = {
  root: null,
  gridContainer: null,
  hud: {
    score: null,
    status: null,
    timer: null,
    message: null
  },
  controls: {
    btnNewGame: null,
    btnDaily: null,
    btnMute: null,
    btnHowToClose: null
  },
  modals: {
    howto: null,
    backdrop: null
  },
  loader: null,
};


/**
 * Query all needed DOM elements and store in gwDom.
 * Call this once in the bootstrap phase.
 */
function cacheDom() {
  gwDom.root          = document.getElementById('gw-panel') || document.getElementById('app') || document.body;
  gwDom.gridContainer = document.getElementById('gw-grid');

  gwDom.hud.score   = document.getElementById('gw-score');
  gwDom.hud.status  = document.getElementById('gw-status');
  gwDom.hud.timer   = document.getElementById('gw-timer');
  gwDom.hud.message = document.getElementById('gw-message');

  // Controls
  gwDom.controls.btnNewGame    = document.getElementById('gw-btn-new');
  gwDom.controls.btnDaily      = document.getElementById('gw-btn-daily');

  // ðŸ”Š Mute button â€“ HTML must have: <button id="muteBtn">ðŸ”Š</button>
  gwDom.controls.btnMute = document.getElementById('muteBtn');
  gwDom.btnMute          = gwDom.controls.btnMute;  // backward-compat alias

  gwDom.controls.btnHowToClose = document.getElementById('gw-howto-close');

  // Modals
  gwDom.modals.howto    = document.getElementById('gw-howto');
  gwDom.modals.backdrop = document.getElementById('gw-backdrop');

  // Loader
  gwDom.loader = document.getElementById('gw-loader');

  // Share button â€“ HTML: <button id="gw-share-btn" ...>Share</button>
  gwDom.btnShare = document.getElementById('gw-share-btn');
  shareBtn       = gwDom.btnShare;  // if older code expects global

  // Background music audio element â€“ HTML: <audio id="bgm" ...>
  gwDom.bgm = document.getElementById('bgm');
  bgm       = gwDom.bgm;
}




// <<< [NOVA-SECTION: DOM REFERENCES â€“ END]
// #endregion
// ============================================================


function unlockBGM() {
  if (bgmStarted || !gwDom.bgm) return;
  bgmStarted = true;

  if (!bgmMuted) {
    gwDom.bgm.play().catch(err => {
      console.log("BGM unlock blocked:", err);
    });
  }
}

// Unlock audio after the first interaction *inside the game iframe*
window.addEventListener("pointerdown", unlockBGM, { once: true });
window.addEventListener("keydown", unlockBGM, { once: true });








// ============================================================
// #region INIT & BOOTSTRAP
// >>> [NOVA-SECTION: INIT & BOOTSTRAP â€“ START]
// ============================================================

/**
 * High-level entry for starting a new GridWord puzzle session.
 * This is called by the FB shell via window.startGridlocked().
 * You can also call it manually in a plain HTML page for testing.
 */

async function initGridWord(options = { platform: 'web' }) {
  cacheDom();
  initAudioState();
  bindCoreEventHandlers();

  // Audio unlock for browser autoplay policies
  setupAudioUnlock();

  // Load any existing daily streak from localStorage
  loadDailyStreak();


  // Load data (dictionary + puzzles) once per session
  await loadDictionary();
  gwState.puzzles = await loadPuzzles();
  PUZZLES = gwState.puzzles;  // also assign to global for easy access

  // Pick & render first puzzle
  const p = pickRandomPuzzle();
  if (p) {
    // Normalize words to uppercase strings
    p.words = (p.words || []).map(w => String(w).toUpperCase());
    renderPuzzle(p, gwState.currentDifficulty);
    gwState.isReady = true;
  } else if (gwDom.root) {
    gwDom.root.textContent = 'No puzzles found.';
  }
}

// High-level entry point: used by FB shell and local testing
window.startGridlocked = async function () {
  const isFB = typeof FBInstant !== 'undefined';

  if (isFB) {
    try {
      // Initialize the Instant Games SDK
      await FBInstant.initializeAsync();
      FBInstant.setLoadingProgress(100);

      // Let FB know weâ€™re ready to start
      await FBInstant.startGameAsync();
      console.log('FBInstant started, booting GridWord v1.2 (CAR-NOVA.i)');
    } catch (err) {
      console.warn('FBInstant init/start failed, falling back to web mode:', err);
    }
  } else {
    console.log('FBInstant not detected, starting GridWord in plain web mode.');
  }

  // Now start the actual game engine
  await initGridWord({ platform: isFB ? 'fb' : 'web' });
};






/**
 * Attach top-level event handlers (e.g., mute button).
 * All per-cell input events live inside the RENDERING section.
 */
function bindCoreEventHandlers() {
  // ðŸ”Š Mute button
  const muteBtn = gwDom.controls?.btnMute || gwDom.btnMute;
  console.log('Mute button wired as:', muteBtn); // debug
  if (muteBtn) {
    muteBtn.addEventListener('click', toggleAudioMute);
  }

  // â„¹ï¸ How-to close
  if (gwDom.controls.btnHowToClose) {
    gwDom.controls.btnHowToClose.addEventListener('click', closeHowTo);
  }

  // Backdrop closes How-to
  if (gwDom.modals.backdrop) {
    gwDom.modals.backdrop.addEventListener('click', closeHowTo);
  }

}



/**
 * Initialize audio (read saved preference from localStorage, etc.).
 */
function initAudioState() {
  try {
    const stored = localStorage.getItem(GW_CONFIG.storageKeys.audioEnabled);
    gwState.audioEnabled = stored === null
      ? GW_CONFIG.audio.enabledByDefault
      : stored === '1';
  } catch (e) {
    gwState.audioEnabled = GW_CONFIG.audio.enabledByDefault;
  }

  updateAudioUi();
}

/**
 * Audio unlock: browser blocks autoplay until first user gesture.
 * We hook a one-time click/keydown to start bgm.
 */
function setupAudioUnlock() {
  if (!gwDom.bgm) return;

  gwDom.bgm.volume = GW_CONFIG.audio.musicVolume;

  function startMusic() {
    if (!gwState.audioEnabled) return;
    gwDom.bgm.play().catch(err => console.log('Audio blocked:', err));
  }

  window.addEventListener('click', startMusic, { once: true });
  window.addEventListener('keydown', startMusic, { once: true });
} 


/**
 * Difficulty helpers: best-time storage + difficulty persistence.
 */
function saveBest(ms, difficulty) {
  const k = GW_CONFIG.storageKeys.bestPrefix + difficulty;
  const old = localStorage.getItem(k);
  if (!old || ms < Number(old)) localStorage.setItem(k, String(ms));
}

function getBest(difficulty) {
  const v = localStorage.getItem(GW_CONFIG.storageKeys.bestPrefix + difficulty);
  return v ? Number(v) : null;
}

// <<< [NOVA-SECTION: INIT & BOOTSTRAP â€“ END]
// #endregion
// ============================================================



// ============================================================
// #region RENDERING (GRID / UI)
// >>> [NOVA-SECTION: RENDERING â€“ START]
// ============================================================

/**
 * Core render for a single puzzle.
 * This builds the entire UI inside #app:
 *  - top bar (title, category, timer, best, difficulty)
 *  - progress bar
 *  - 5x5 interlocking grid with inputs
 *  - clues list
 *  - status + toolbar (Check / Hint / Next)
 */

function renderPuzzle(puzzle, diff = gwState.currentDifficulty) {
  gwDom.root = document.getElementById('gw-panel') 
           || document.getElementById('app') 
           || document.body;
    const app = gwDom.root;
  if (!app) return;

  app.innerHTML = '';

  // ---------- PICK & PLACE LOOP (uses GAME LOGIC helpers) ----------
  let result = null;        // { grid, used, clueMap }
  let picked = puzzle;

  for (let tries = 0; tries < 100 && !result; tries++) {
    const clueMap = {};
    (picked.words || []).forEach((w, i) => {
      const key = (w || '').toUpperCase();
      clueMap[key] = (picked.clues || [])[i] || '(no clue)';
    });

    const usable = (picked.words || [])
      .map(w => (w || '').toUpperCase())
      .filter(w => w.length >= 3 && w.length <= GRID_SIZE);

    if (usable.length < 5) {
      picked = pickRandomPuzzle();
      if (!picked) break;
      continue;
    }

    // Try multiple random 5-word subsets from this puzzle
    for (let s = 0; s < 24 && !result; s++) {
      const five = [...usable].sort(() => Math.random() - 0.5).slice(0, 5);
      if (!isConnectedByLetters(five)) continue;

      for (let i = 0; i < 80 && !result; i++) {
        const placed = placeWordsSuperNova(five);
        if (placed) {
          result = {
            grid: placed.grid,
            used: placed.used,
            clueMap
          };
        }
      }
    }

    if (!result) picked = pickRandomPuzzle();
    if (!picked) break;
  }

  if (!result) {
    app.textContent = 'Could not interlock these words. Try another.';
    return;
  }

const grid = result.grid;
const used = result.used;

// Assign live puzzle data to BOTH globals and gwState
currentSolutionGrid = grid;
currentInputs = Array.from({ length: GRID_SIZE }, () =>
  Array(GRID_SIZE).fill(null)
);

gwState.currentSolutionGrid = grid;
gwState.currentInputs = currentInputs;

  // ---------- TOP BAR ----------
  const topbar = document.createElement('div');
  topbar.className = 'topbar';

  const titleWrap = document.createElement('div');
  titleWrap.className = 'title-wrap';

  const h1 = document.createElement('h1');
  h1.innerHTML = `Gridword <span class="badge">CAR-NOVA.i</span>`;

const sub = document.createElement('div');
sub.className = 'subtitle';

const modeLabel = gwState.isDaily ? 'Daily' : 'Classic';

sub.textContent = picked.category
  ? `Category: ${picked.category} â€¢ Mode: ${modeLabel}`
  : `Category: mixed â€¢ Mode: ${modeLabel}`;

  const helpBtn = document.createElement('button');
helpBtn.className = 'icon-help';
helpBtn.textContent = '?';
helpBtn.title = 'How to play';
helpBtn.onclick = openHowTo;

  titleWrap.appendChild(h1);
  titleWrap.appendChild(sub);
  titleWrap.appendChild(helpBtn);

  const hud = document.createElement('div');
  hud.className = 'hud';

  const timeChip = document.createElement('div');
  timeChip.className = 'chip';
  timeChip.innerHTML = `Time: <span id="time-val">00:00</span>`;

  const bestChip = document.createElement('div');
  bestChip.className = 'chip';
  const best = getBest(diff);
  bestChip.innerHTML = `Best (${diff}): <span id="best-val">${best ? fmt(best) : '--:--'}</span>`;

    const dailyChip = document.createElement('div');
  dailyChip.className = 'chip chip-daily';
  dailyChip.id = 'daily-chip';

  // Initial label based on current streak
  const streak = gwState.dailyStreak || 0;
  if (streak > 0) {
    dailyChip.innerHTML = `<span class="icon">ðŸ”¥</span><span>Streak: ${streak}</span>`;
  } else {
    dailyChip.innerHTML = `<span class="icon">ðŸŒ“</span><span>Streak: --</span>`;
  }


  const diffSel = document.createElement('select');
  diffSel.innerHTML = `
    <option value="easy">Easy</option>
    <option value="normal">Normal</option>
    <option value="hard">Hard</option>
  `;
  diffSel.value = diff;
  diffSel.onchange = () => {
    gwState.currentDifficulty = diffSel.value;
    localStorage.setItem(GW_CONFIG.storageKeys.diff, gwState.currentDifficulty);
    stopTimer();
    const np = pickRandomPuzzle();
    if (np) {
      np.words = (np.words || []).map(w => String(w).toUpperCase());
      renderPuzzle(np, gwState.currentDifficulty);
    }
  };

  hud.appendChild(timeChip);
  hud.appendChild(bestChip);
  hud.appendChild(dailyChip);
  hud.appendChild(diffSel);

  topbar.appendChild(titleWrap);
  topbar.appendChild(hud);
  app.appendChild(topbar);

  // ---------- PROGRESS BAR ----------
  const progWrap = document.createElement('div');
  progWrap.className = 'progress-wrap';

  const progBar = document.createElement('div');
  progBar.className = 'progress-bar';

  progWrap.appendChild(progBar);
  app.appendChild(progWrap);

  // ---------- GRID ----------
  const gridFrame = document.createElement('div');
  gridFrame.className = 'grid-frame';

  const gridEl = document.createElement('div');
  gridEl.className = 'grid';

  const hintMask = buildHintMask(grid, diff);

  let timerStarted = false;
  const timeEl = () => document.getElementById('time-val');

  function focusCell(rr, cc) {
    const inp = gwState.currentInputs?.[rr]?.[cc];
    if (inp && !inp.classList.contains('given')) inp.focus();
  }

  function stepTo(r, c, dr, dc) {
    let rr = r;
    let cc = c;

    for (let k = 0; k < GRID_SIZE * GRID_SIZE; k++) {
      rr = clamp(rr + dr, 0, GRID_SIZE - 1);
      cc = clamp(cc + dc, 0, GRID_SIZE - 1);
      const tgt = gwState.currentInputs[rr][cc];
      if (tgt) {
        focusCell(rr, cc);
        return { rr, cc };
      }
    }

    return { rr: r, cc: c };
  }

  for (let r = 0; r < GRID_SIZE; r++) {
    for (let c = 0; c < GRID_SIZE; c++) {
      const cell = document.createElement('div');
      const letter = grid[r][c];

      if (letter === '-') {
        cell.className = 'cell block';
        gridEl.appendChild(cell);
        gwState.currentInputs[r][c] = null;
        continue;
      }

      cell.className = 'cell playable';

      const inp = document.createElement('input');
      inp.setAttribute('maxlength', '1');
      inp.setAttribute('placeholder', 'â€¢');
      inp.dataset.r = String(r);
      inp.dataset.c = String(c);
      inp.tabIndex = 0;

      // Given / hint cells
      if (hintMask[r][c]) {
        inp.value = letter;
        inp.classList.add('given');
        inp.readOnly = true;
      }  else {
        // Player input cells
        inp.value = '';

        // Decide auto-advance direction when the player CLICKS this cell:
        //  - If top row (r === 0) and NOT top-left (c > 0) â†’ go DOWN
        //  - Otherwise â†’ go RIGHT
        inp.addEventListener('pointerdown', () => {
          const rr = Number(inp.dataset.r);
          const cc = Number(inp.dataset.c);

          if (rr === 0 && cc > 0) {
            // Vertical typing (downwards)
            gwState.advanceDir = { dr: 1, dc: 0 };
          } else {
            // Horizontal typing (to the right)
            gwState.advanceDir = { dr: 0, dc: 1 };
          }
        });

          inp.addEventListener('input', () => {
    inp.value = (inp.value || '').slice(0, 1).toUpperCase();

    if (!timerStarted) {
      timerStarted = true;
      startTimer(timeEl());
    }

    // Little pulse on the tile when you type
    const cellEl = inp.parentElement;
    if (cellEl) {
      cellEl.classList.remove('anim-input');  // restart animation if spammed
      void cellEl.offsetWidth;                // force reflow to reset animation
      cellEl.classList.add('anim-input');
      setTimeout(() => cellEl.classList.remove('anim-input'), 180);
    }

    updateProgress(progBar);

    if (inp.value) {
      const dir = gwState.advanceDir || { dr: 0, dc: 1 };
      stepTo(r, c, dir.dr, dir.dc);
    }
  });


        inp.addEventListener('keydown', (e) => {
          if (e.key === 'ArrowRight') {
            e.preventDefault();
            stepTo(r, c, 0, +1);
          } else if (e.key === 'ArrowLeft') {
            e.preventDefault();
            stepTo(r, c, 0, -1);
          } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            stepTo(r, c, +1, 0);
          } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            stepTo(r, c, -1, 0);
          } else if (e.key === 'Backspace') {
            if (!inp.value) {
              e.preventDefault();
              const { rr, cc } = stepTo(r, c, 0, -1);
              const prev = gwState.currentInputs[rr][cc];
              if (prev && !prev.classList.contains('given')) prev.value = '';
              updateProgress(progBar);
            }
          } else if (e.key === 'Home') {
            e.preventDefault();
            for (let cc = 0; cc < GRID_SIZE; cc++) {
              if (gwState.currentSolutionGrid[r][cc] !== '-') {
                focusCell(r, cc);
                break;
              }
            }
          } else if (e.key === 'End') {
            e.preventDefault();
            for (let cc = GRID_SIZE - 1; cc >= 0; cc--) {
              if (gwState.currentSolutionGrid[r][cc] !== '-') {
                focusCell(r, cc);
                break;
              }
            }
          } else if (e.key === 'Enter') {
            e.preventDefault();
            // move right else wrap to next row's first playable
            for (let cc = c + 1; cc < GRID_SIZE; cc++) {
              if (gwState.currentSolutionGrid[r][cc] !== '-') {
                focusCell(r, cc);
                return;
              }
            }
            for (let rr = r + 1; rr < GRID_SIZE; rr++) {
              for (let cc = 0; cc < GRID_SIZE; cc++) {
                if (gwState.currentSolutionGrid[rr][cc] !== '-') {
                  focusCell(rr, cc);
                  return;
                }
              }
            }
          }
        });
      }



      gwState.currentInputs[r][c] = inp;
      cell.appendChild(inp);
      gridEl.appendChild(cell);
    }
  }

  gridFrame.appendChild(gridEl);
  app.appendChild(gridFrame);

    // --- v1.2.3: Grid entry + idle motion ---
  if (gridEl) {
    // Entry animation
    gridEl.classList.add('grid-enter');
    setTimeout(() => {
      gridEl.classList.remove('grid-enter');
      // Start subtle idle glow once fully in
      gridEl.classList.add('grid-idle');
    }, 500);
  }


  // ---------- CLUES (ordered by placed words) ----------
  const placedClues = used.map(w => result.clueMap[w] || '(no clue)');

  const clues = document.createElement('div');
  clues.id = 'clues';
  clues.innerHTML = '<strong>Clues</strong><br>' +
    placedClues.map((c, i) => `${i + 1}. ${c}`).join('<br>');

  app.appendChild(clues);
  

  // ---------- STATUS & CONTROLS ----------
const status = document.createElement('div');
status.id = 'status';
status.textContent = 'Good luck!';
app.appendChild(status);

const toolbar = document.createElement('div');
toolbar.className = 'toolbar';
toolbar.id = 'gw-toolbar';

// CHECK BTN
const checkBtn = document.createElement('button');
checkBtn.textContent = 'Check';
checkBtn.className = 'sec-btn';
checkBtn.onclick = () => {
  const ok = checkSolution();
  if (ok) {
    floatScore('Solved!');
    status.textContent = 'Solved! ðŸŽ‰';
  } else {
    status.textContent = 'Some letters are incorrect.';
  }
};

// HINT BTN
const hintBtn = document.createElement('button');
hintBtn.textContent = 'Hint';
hintBtn.className = 'sec-btn';
hintBtn.onclick = () => {
  const revealed = revealOneCell();
  if (revealed) {
    gwState.startTime -= 10000; // +10s penalty
    status.textContent = 'Hint revealed. (+10s)';
    updateProgress(progBar);
  } else {
    status.textContent = 'No more hints to reveal.';
  }
};

// NEXT BTN
const nextBtn = document.createElement('button');
nextBtn.textContent = 'Next';
nextBtn.className = 'sec-btn';
nextBtn.onclick = () => {
  stopTimer();
  const np = pickRandomPuzzle();
  if (np) renderPuzzle(np, gwState.currentDifficulty);
};

// DAILY BTN
const dailyBtn = document.createElement('button');
dailyBtn.id = 'gw-daily-btn';
dailyBtn.textContent = 'Daily';
dailyBtn.className = 'sec-btn';
dailyBtn.onclick = () => {
  const dp = pickDailyPuzzle();
  renderPuzzle(dp, gwState.currentDifficulty);
};

// ---------------------------------------------------------
// SHARE BUTTON  (modern + safe + globally compatible)
// ---------------------------------------------------------

// Create button once per puzzle render
const shareBtn = document.createElement("button");
shareBtn.id = "gw-share-btn";
shareBtn.textContent = "Share";
shareBtn.className = "sec-btn";





// Append buttons (shareBtn MUST exist here)
toolbar.appendChild(checkBtn);
toolbar.appendChild(hintBtn);
toolbar.appendChild(nextBtn);
toolbar.appendChild(dailyBtn);
toolbar.appendChild(shareBtn);

app.appendChild(toolbar);






  // ---------- Kick timer & initial progress ----------
  const tv = document.getElementById('time-val');
  if (tv) startTimer(tv);
  updateProgress(progBar);
}

// <<< [NOVA-SECTION: RENDERING â€“ END]
// #endregion
// ============================================================



// ============================================================
// #region INPUT HANDLING (Keyboard / Pointer / Touch)
// >>> [NOVA-SECTION: INPUT HANDLING â€“ START]
// ============================================================

/**
 * Global keyboard handlers are not strictly required here because
 * all per-cell input logic is attached in renderPuzzle().
 *
 * This section is reserved for future global shortcuts
 * (e.g., R to restart, H for hint, etc.).
 */

// Example: basic global shortcut for "Next" puzzle
//window.addEventListener('keydown', (e) => {
//  if (!gwState.isReady) return;
//  if (e.key === 'n' || e.key === 'N') {
//    const np = pickRandomPuzzle();
//    if (np) {
//      stopTimer();
//      np.words = (np.words || []).map(w => String(w).toUpperCase());
//      renderPuzzle(np, gwState.currentDifficulty);
//}
//  }
//});

// <<< [NOVA-SECTION: INPUT HANDLING â€“ END]
// #endregion
// ============================================================



// ============================================================
// #region GAME LOGIC (Validation, Scoring, End-of-Puzzle)
// >>> [NOVA-SECTION: GAME LOGIC â€“ START]
// ============================================================

/**
 * Graph connectivity check: ensures the chosen 5 words
 * form a single connected component via shared letters.
 */
function isConnectedByLetters(words) {
  if (words.length < 2) return false;

  const n = words.length;
  const adj = Array.from({ length: n }, () => []);
  const sets = words.map(w => new Set(w.split('')));

  for (let i = 0; i < n; i++) {
    for (let j = i + 1; j < n; j++) {
      let share = false;
      for (const ch of sets[i]) {
        if (sets[j].has(ch)) {
          share = true;
          break;
        }
      }
      if (share) {
        adj[i].push(j);
        adj[j].push(i);
      }
    }
  }

  const seen = new Set([0]);
  const q = [0];

  while (q.length) {
    const u = q.shift();
    for (const v of adj[u]) {
      if (!seen.has(v)) {
        seen.add(v);
        q.push(v);
      }
    }
  }

  return seen.size === n;
}

/**
 * Extract contiguous letter chains (length >= 3) from rows & cols
 * of the completed grid, used for dictionary filtering.
 */
function extractChains(grid, minLen = 3) {
  const N = grid.length;
  const chains = [];

  // rows
  for (let r = 0; r < N; r++) {
    let run = [];
    for (let c = 0; c < N; c++) {
      const ch = grid[r][c];
      if (ch !== '-') run.push(ch);
      if (ch === '-' || c === N - 1) {
        if (run.length >= minLen) chains.push(run.join(''));
        run = [];
      }
    }
  }

  // cols
  for (let c = 0; c < N; c++) {
    let run = [];
    for (let r = 0; r < N; r++) {
      const ch = grid[r][c];
      if (ch !== '-') run.push(ch);
      if (ch === '-' || r === N - 1) {
        if (run.length >= minLen) chains.push(run.join(''));
        run = [];
      }
    }
  }

  return chains;
}

/**
 * Dictionary-based sanity check:
 *  - Allow target words (the 5 chosen)
 *  - All other 3+ chains must be valid English words (if dictionary loaded)
 */
function gridLooksEnglish(grid, targetWordsUpper) {
  if (!gwState.wordSet || gwState.wordSet.size === 0) return true;

  const target = new Set(targetWordsUpper.map(w => w.toUpperCase()));
  const chains = extractChains(grid, 3);

  for (const s of chains) {
    if (target.has(s)) continue;
    if (!gwState.wordSet.has(s.toLowerCase())) return false;
  }

  return true;
}

/**
 * Placement engine â€“ attempts to interlock 5 words in a 5x5 grid.
 * Returns { grid, used } or null on failure.
 */
function placeWordsSuperNova(words, maxShuffles = 40) {
  const N = GRID_SIZE;

  const W = words
    .map(w => w.toUpperCase())
    .filter(w => w.length >= 2 && w.length <= N);

  if (W.length < 5) return null;

  function empty() {
    return Array.from({ length: N }, () => Array.from({ length: N }, () => '-'));
  }

  function canPlace(grid, word, r, c, dr, dc, requireOverlap) {
    let overlaps = 0;
    for (let i = 0; i < word.length; i++) {
      const rr = r + dr * i;
      const cc = c + dc * i;
      if (rr < 0 || rr >= N || cc < 0 || cc >= N) return false;
      const cell = grid[rr][cc];
      if (cell !== '-' && cell !== word[i]) return false;
      if (cell === word[i]) overlaps++;
    }
    return requireOverlap ? overlaps > 0 : true;
  }

  function doPlace(grid, word, r, c, dr, dc) {
    for (let i = 0; i < word.length; i++) {
      grid[r + dr * i][c + dc * i] = word[i];
    }
  }

  function undoPlace(grid, word, r, c, dr, dc, before) {
    for (let i = 0; i < word.length; i++) {
      grid[r + dr * i][c + dc * i] = before[i];
    }
  }

  function backtrack(grid, idx, order) {
    if (idx === order.length) return true;

    const word = order[idx];
    const dirs = [
      { dr: 0, dc: 1 },  // horizontal
      { dr: 1, dc: 0 }   // vertical
    ];

    for (const { dr, dc } of dirs) {
      const maxR = dr === 0 ? N : N - word.length + 1;
      const maxC = dc === 0 ? N : N - word.length + 1;

      for (let r = 0; r < maxR; r++) {
        for (let c = 0; c < maxC; c++) {
          const requireOverlap = idx > 0;
          if (!canPlace(grid, word, r, c, dr, dc, requireOverlap)) continue;

          const before = [];
          for (let i = 0; i < word.length; i++) {
            before.push(grid[r + dr * i][c + dc * i]);
          }

          doPlace(grid, word, r, c, dr, dc);

          if (backtrack(grid, idx + 1, order)) return true;

          undoPlace(grid, word, r, c, dr, dc, before);
        }
      }
    }

    return false;
  }

  for (let s = 0; s < maxShuffles; s++) {
    const order = [...W].sort((a, b) => b.length - a.length);

    // shuffle from index 1 downwards to vary
    for (let i = order.length - 1; i > 1; i--) {
      const j = Math.floor(Math.random() * (i - 1)) + 1;
      [order[i], order[j]] = [order[j], order[i]];
    }

    const pick = order.slice(0, 5);
    const grid = empty();

    if (backtrack(grid, 0, pick) && gridLooksEnglish(grid, pick)) {
      return { grid, used: pick };
    }
  }

  return null;
}

/**
 * Hint mask for given letters by difficulty.
 */
function buildHintMask(grid, diffKey) {
  const percent = DIFF_HINTS[diffKey] ?? DIFF_HINTS.normal;
  const mask = Array.from({ length: GRID_SIZE }, () =>
    Array.from({ length: GRID_SIZE }, () => false)
  );

  const letters = [];
  for (let r = 0; r < GRID_SIZE; r++) {
    for (let c = 0; c < GRID_SIZE; c++) {
      if (grid[r][c] !== '-') letters.push([r, c]);
    }
  }

  const give = Math.max(2, Math.floor(letters.length * percent));
  letters.sort(() => Math.random() - 0.5);

  for (let i = 0; i < give; i++) {
    const [r, c] = letters[i];
    mask[r][c] = true;
  }

  return mask;
}

/**
 * Progress bar helpers (correct / total).
 */

function countLetterCells() {
  let t = 0;
  for (let r = 0; r < GRID_SIZE; r++) {
    for (let c = 0; c < GRID_SIZE; c++) {
      if (gwState.currentSolutionGrid?.[r]?.[c] !== '-') t++;
    }
  }
  return t;
}

function countCorrectCells() {
  let n = 0;
  for (let r = 0; r < GRID_SIZE; r++) {
    for (let c = 0; c < GRID_SIZE; c++) {
      const sol = gwState.currentSolutionGrid?.[r]?.[c];
      if (sol === '-' || sol == null) continue;
      const inp = gwState.currentInputs?.[r]?.[c];
      if (inp && (inp.value || '').toUpperCase() === sol) n++;
    }
  }
  return n;
}

function updateProgress(barEl) {
  const total = countLetterCells();
  const correct = countCorrectCells();
  const pct = total ? Math.floor((correct / total) * 100) : 0;
  if (barEl) barEl.style.width = pct + '%';
}

/**
 * Check solution and update best times.
 */
function checkSolution() {
  let ok = true;

    const diff = gwState.currentDifficulty;


  for (let r = 0; r < GRID_SIZE; r++) {
    for (let c = 0; c < GRID_SIZE; c++) {
      const sol = currentSolutionGrid[r][c];
      if (sol === '-') continue;

      const inp = currentInputs[r][c];
      if (!inp) continue;

      const cell = inp.parentElement;
      const val = (inp.value || '').toUpperCase();

      if (val === sol) {
        cell.classList.remove('bad');
        cell.classList.add('correct');
      } else {
        cell.classList.add('bad');
        ok = false;
      }
    }
  }

  if (ok) {
    stopTimer();
    const elapsed = performance.now() - gwState.startTime;
    saveBest(elapsed, diff);

    gwState.lastResult = {
  isSuccess: true,
  isDaily: gwState.isDaily,
  diff,
  timeMs: elapsed,
  streak: gwState.dailyStreak
};

    const bv = getBest(diff);
    const bEl = document.getElementById('best-val');
    if (bEl) bEl.textContent = bv ? fmt(bv) : '--:--';

    // Always grab the status element directly
    const statusEl = document.getElementById('status');

    if (gwState.isDaily) {
      const streak = updateDailyStreak();
      if (statusEl) {
        statusEl.textContent =
          `Daily solved! ðŸ”¥ Streak: ${streak} day${streak === 1 ? '' : 's'}.`;
      }

      const chip = document.getElementById('daily-chip');
      if (chip) {
        chip.innerHTML = `<span class="icon">ðŸ”¥</span><span>Streak: ${streak}</span>`;
        chip.classList.remove('hot');
        void chip.offsetWidth;           // restart CSS animation
        chip.classList.add('hot');
      }
    } else {
      if (statusEl) statusEl.textContent = 'Solved! ðŸŽ‰';
    }
  }

  return ok;
}


/**
 * Reveal a single incorrect/non-given cell as a hint.
 */
function revealOneCell() {
  for (let r = 0; r < GRID_SIZE; r++) {
    for (let c = 0; c < GRID_SIZE; c++) {

      const sol = currentSolutionGrid[r][c];
      if (sol === '-') continue;

      const inp = currentInputs[r][c];
      if (!inp) continue;

      const val = (inp.value || '').toUpperCase();

      // Only target non-given, incorrect cells
      if (!inp.classList.contains('given') && val !== sol) {
        // Reveal correct letter
        inp.value = sol;
        inp.classList.add('given');
        inp.readOnly = true;

        const cellEl = inp.parentElement;

        if (cellEl) {
          // Clear any previous error styling
          cellEl.classList.remove('bad');
          cellEl.classList.add('correct');

          // Super Nova hint flash âœ¨ (CSS: .cell.hint-flash)
          cellEl.classList.remove('hint-flash');
          void cellEl.offsetWidth;     // restart animation
          cellEl.classList.add('hint-flash');

          setTimeout(() => {
            cellEl.classList.remove('hint-flash');
          }, 450);
        }

        return true;
      }
    }
  }
  return false;
}




// <<< [NOVA-SECTION: GAME LOGIC â€“ END]
// #endregion
// ============================================================



// ============================================================
// #region AUDIO & FX (Micro-Animations, Sounds)
// >>> [NOVA-SECTION: AUDIO & FX â€“ START]
// ============================================================

function toggleAudioMute() {
  gwState.audioEnabled = !gwState.audioEnabled;

  try {
    localStorage.setItem(
      GW_CONFIG.storageKeys.audioEnabled,
      gwState.audioEnabled ? '1' : '0'
    );
  } catch (e) {}

  // Set our own mute flag
  bgmMuted = !gwState.audioEnabled;

  updateAudioUi();

  if (gwDom.bgm) {
    if (bgmMuted) {
      gwDom.bgm.pause();
    } else {
      // If audio already started, resume it
      if (bgmStarted) {
        gwDom.bgm.play().catch(err => console.log("Resume blocked:", err));
      }
    }
  }
}

function updateAudioUi() {
  const btn = gwDom.controls?.btnMute || gwDom.btnMute;
  if (!btn) return;
  btn.textContent = gwState.audioEnabled ? 'ðŸ”Š' : 'ðŸ”‡';
}




function unlockBGM() {
  if (bgmStarted) return;
  bgmStarted = true;

  if (!bgmMuted) {
    bgm.play().catch(err => {
      console.log("BGM play blocked:", err);
    });
  }

  window.removeEventListener("pointerdown", unlockBGM);
  window.removeEventListener("keydown", unlockBGM);
}

// Start music after first interaction
window.addEventListener("pointerdown", unlockBGM, { once: true });
window.addEventListener("keydown", unlockBGM, { once: true });


// Placeholder FX hooks if we want micro-animations later
function playSfxInput() { /* no-op for now */ }
function playSfxPuzzleComplete() { /* no-op for now */ }




// <<< [NOVA-SECTION: AUDIO & FX â€“ END]
// #endregion
// ============================================================



// ============================================================
// #region DAILY MODE (Optional v1.2 Feature)
// >>> [NOVA-SECTION: DAILY MODE â€“ START]
// ============================================================

/**
 * DAILY MODE is not wired to the interlocking puzzle mode yet.
 * These are stubs for future expansion (e.g., fixed daily seed).
 */

function getTodaySeed() {
  const now = new Date();
  const y = now.getFullYear();
  const m = now.getMonth() + 1;
  const d = now.getDate();
  return `${y}-${m}-${d}`;
}

function loadDailyProgress() {
  // TODO: read streak, lastPlayed date from localStorage
}

function saveDailyProgress(_completed) {
  // TODO: update streak and lastPlayed date
}

// <<< [NOVA-SECTION: DAILY MODE â€“ END]
// #endregion
// ============================================================



// ============================================================
// #region PLATFORM INTEGRATION (FB Instant, etc.)
// >>> [NOVA-SECTION: PLATFORM INTEGRATION â€“ START]
// ============================================================

/**
 * All platform-related calls (FB Instant, sharing, leaderboards, etc.)
 * would live here. For now, we just expose the entry point.
 */

// FB / host entry point
window.startGridlocked = async function () {
  showLoader();
  await initGridWord({ platform: 'fb' });
  hideLoader();
};





// <<< [NOVA-SECTION: PLATFORM INTEGRATION â€“ END]
// #endregion
// ============================================================



// ============================================================
// #region UTILITIES
// >>> [NOVA-SECTION: UTILITIES â€“ START]
// ============================================================

/**
 * Small helper functions that don't belong to a specific section.
 */

// Time formatting â€“ MM:SS
function fmt(ms) {
  const s = Math.floor(ms / 1000);
  const m = Math.floor(s / 60);
  const r = s % 60;
  return `${m.toString().padStart(2, '0')}:${r.toString().padStart(2, '0')}`;
}

function clamp(value, min, max) {
  return Math.max(min, Math.min(max, value));
}

// Timer helpers for this mode
function startTimer(el) {
  stopTimer();
  gwState.startTime = performance.now();
  gwState.timerId = setInterval(() => {
    if (!el) return;
    el.textContent = fmt(performance.now() - gwState.startTime);
  }, 200);
}

function stopTimer() {
  if (gwState.timerId) {
    clearInterval(gwState.timerId);
    gwState.timerId = null;
  }
}

/**
 * Floating message for micro-reward feedback.
 */
function floatScore(msg) {
  const app = gwDom.root;
  if (!app) return;
  const el = document.createElement('div');
  el.className = 'float-score';
  el.textContent = msg;
  app.appendChild(el);
  setTimeout(() => el.remove(), 800);
}

/**
 * Data loading: puzzles + optional dictionary
 */

async function loadPuzzles() {
  try {
    const res = await fetch(GW_CONFIG.files.puzzles);
    if (!res.ok) throw new Error('not ok');
    return await res.json();
  } catch (e) {
    // fallback demo
    return [{
      category: 'DEMO',
      words: ['TIGER', 'ZEBRA', 'HORSE', 'WHALE', 'PIZZA'],
      clues: [
        'A large wild cat with stripes.',
        'A striped animal found in Africa.',
        'Often ridden by cowboys.',
        'A large marine mammal.',
        'A baked dish with sauce and cheese.'
      ]
    }];
  }
}

function pickRandomPuzzle() {
  if (!gwState.puzzles.length) return null;
  return gwState.puzzles[Math.floor(Math.random() * gwState.puzzles.length)];
}

function hashStringToInt(str) {
  let h = 0;
  for (let i = 0; i < str.length; i++) {
    h = (h * 31 + str.charCodeAt(i)) >>> 0;
  }
  return h;
}

function pickDailyPuzzle() {
  if (!PUZZLES || !PUZZLES.length) return null;
  const key = getTodayKey();
  const h   = hashStringToInt(key);
  const idx = h % PUZZLES.length;
  const base = PUZZLES[idx];

  // Clone so we don't mutate master PUZZLES
  const clone = JSON.parse(JSON.stringify(base || {}));
  if (clone.words) {
    clone.words = clone.words.map(w => String(w).toUpperCase());
  }
  return { puzzle: clone, key };
}



async function loadDictionary() {
  try {
    const res = await fetch(GW_CONFIG.files.dictionary);
    const arr = await res.json();
    gwState.wordSet = new Set(arr.map(s => s.toLowerCase()));
  } catch (e) {
    gwState.wordSet = new Set(); // allow everything if file missing
  }
}
//
// ------------------------------------------ Daily Mode Helpers ---------------------------------------------------------------------------
//
const DAILY_LAST_KEY   = 'gridlocked_daily_last';
const DAILY_STREAK_KEY = 'gridlocked_daily_streak';

function getTodayKey() {
  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth() + 1).padStart(2, '0');
  const d = String(now.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
}

function diffDays(a, b) {
  // a, b are "YYYY-MM-DD"
  const pa = a.split('-').map(Number);
  const pb = b.split('-').map(Number);
  const da = new Date(pa[0], pa[1] - 1, pa[2]);
  const db = new Date(pb[0], pb[1] - 1, pb[2]);
  const ms = da - db;
  return Math.round(ms / 86400000);
}

// Update local daily streak, return new streak
function updateDailyStreak() {
  const today = getTodayKey();
  const last  = localStorage.getItem(DAILY_LAST_KEY);
  let streak  = parseInt(localStorage.getItem(DAILY_STREAK_KEY) || '0', 10);

  if (!last) {
    // First ever daily
    streak = 1;
  } else {
    const gap = diffDays(today, last);
    if (gap === 0) {
      // Already counted today â€“ leave streak as-is
      return streak;
    } else if (gap === 1) {
      // Consecutive day
      streak = streak + 1;
    } else {
      // Missed a day (or more) â€“ reset
      streak = 1;
    }
  }

  localStorage.setItem(DAILY_LAST_KEY, today);
  localStorage.setItem(DAILY_STREAK_KEY, String(streak));
  gwState.dailyStreak = streak;
  gwState.dailyKey = today;
  return streak;
}

// Read stored streak when app loads
function loadDailyStreak() {
  const last  = localStorage.getItem(DAILY_LAST_KEY);
  const raw   = localStorage.getItem(DAILY_STREAK_KEY);
  const streak = raw ? parseInt(raw, 10) : 0;
  gwState.dailyKey = last;
  gwState.dailyStreak = Number.isFinite(streak) ? streak : 0;
}


// ------------- "How to Play" Modal -------------

function openHowTo() {
  const m = gwDom.modals.howto;
  const b = gwDom.modals.backdrop;
  if (!m || !b) return;
  m.classList.remove('hidden');
  b.classList.remove('hidden');
  requestAnimationFrame(() => {
    m.classList.add('show');
    b.classList.add('show');
  });
}

function closeHowTo() {
  const m = gwDom.modals.howto;
  const b = gwDom.modals.backdrop;
  if (!m || !b) return;
  m.classList.remove('show');
  b.classList.remove('show');
  setTimeout(() => {
    m.classList.add('hidden');
    b.classList.add('hidden');
  }, 200);
}


function showLoader() {
  if (gwDom.loader) {
    gwDom.loader.classList.remove('is-hidden');
  }
}

function hideLoader() {
  if (gwDom.loader) {
    gwDom.loader.classList.add('is-hidden');
  }
}



// <<< [NOVA-SECTION: UTILITIES â€“ END]
// #endregion
/*
+++++++++=*-=++=::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::==+
+++++++++-++--::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::=+*
+++++++++--+--::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::==-=+++
+++++++++--=+-:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::-==+++++
+++++++++---+=::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::=++++++
+++++++++----+-:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::+++++++
+++++++++--=-==:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::---::-:::++++++++
+++++++++--*-::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::-+++++++=++++++=++
+++++++++--*-::::::::::::::::::::::::::::::::::::::::::::::::::::::::::+=::::::::::::::::::::::::::::::::++======+++++==++=
+++++++++--+-::::::::::::::::::::::::::::::::::::::::::::-::::::::::::=++-:::::::::::-====::::::::::::::=+======+++++=+=+==
+++++++++:-+-::::::::::::::::::::::::::::::::::::::::::::=-:::::::::::+++=:+==-::::====+==:::::::::::::-=====+=+++++=======
+++++++++:-+-:::::::::::::::::::::::::::::::::::::::--:::+:-=-:::---::-*==-:=++=-:===++==::::::::::::::::====+++++=======**
+++++++++-==-:::::::::::::::::::::::::::::::::::::::::::::::.::::-==+++*==+-:++++===+===-::::::::::::::::==++++++=======+*+
+++++++++:-=-:+++=::::::::::::::::::::::::::::::::::::::::......:::::::-+*+=--++++=+=--::::-:::::::::----==++++++=====+=++=
+++++++++-:-=:=+++::::::::::::::::::::::::::::::-::::::::::........::::::::+#+**+***#*+==+=:::::::::-+++==++==+++=====+=+++
+++++++++:--::===+=:::::::::::::::::::::::::::-:::::::::::::::::.:::::::::::-+*####*+====-+*+::::-::======++==++===+==+=++=
+++++++++:-:::==-++-:::::::::::::::::::::::::-::::::::::::::::::::::::::::::-:+##%%##***==**++-:-=:=+=:--=====++===+==+=++=
+++++++++-=--:==:=++::::::::::::::::::::::::-::::::::::::::::::::::::::::::::--=#*#####**+***++:=-:--===+=====++++=+==+=++=
+++++++++---=:=-::=::::::::::::::::::::::::-::::::::::::::::::::::::::::::::::-:=###%%%%#****++==-====++======++++=+==+==++
+++++++++--=-:=--:::::::::::::::::::::-:--+--------------:::::::::::::::::-::::+-*##**##%##***++=+-====+======++++=+==+=+++
+++++++++--*=-=--:::::::::::::::::-------====--------=--------------------=====*=+###**+++*###**:::-=+*++=====++++=+==+++++
+++++++++--*+-=----:::::::::::::-========*======-----------====--------===+++++*=+*#%%###**####*+=--::-====+==++=+=+=++++==
++++++++=--++-=--=-=---::::::::==========*====--::::::---=========----=+++***++*=*%#%*#%%+++###**+=#+#*=======++=+=++++==+=
++++++++=--++-==-=-====::::::::+=------=+==---::::::::::---======---=+******++#==+*%%@@%#%%*#%%%%*#+**+=+=====++=++++======
++++++++=--++-=--=-==-==::::::==:::::--=+--:::::--::::--------------+####***+#*===+*#%@@@%@@@@%%%%*+#+==-----=+++++========
++++++++=--++-=--=-==--=-:::::+::::::::--:::==++++*++=====----:::::+####***+*#+==+=*#%%%@@@#==%%%%%#**+=+=++=+++++=========
++++++++=--++-==-=-==:::::::::++++=-:::=:-=++++*******+=---::::::::#%##*****%+++++++*##%%@@@@@%%%%%####**+=++++++========++
++++++++=--++-=+=--==-:::::::-****+++++*++++++**###%#***+=-::::::::*####***%*+++=+++++*%%%@@@%%%%%%#%#+==+++==+++=======+*=
++++++++=--=+--++=:==--::::::=*###**+++#**+++**#%%%%%%%%%%%%**=::::=%###**%*+++++++++++#%#%@%%%%%%%%%#*+=:-====++=====+=++*
++++++++=:===---++===--::::-*#%%%%%#***%%#*****#%%%%%%%%@@@@@@%#*+==+####%***++++++++++#**#%%%%%%%%%%#+++======++=+===+==**
****++++=-:-=-::-====--:::*#%@@%%%%%%*#=+=+%#*###%%%%%@@@@@@@@@@@#**+=%%##***+++++++++*#**###*#%%%###*#*+======++===+=+****
**********+:-+::-====--::-#%@@%%%%%%%%==--=++#@%##%%%@@@@@@@@@@@@@#*##-####****+++++++#**+***+*###**#*++=======++===++###**
*******+++++-:-:-====:---:*%@@@@@@@@@--::-=++###%##%%@@@%#+#%@@@@@#=====####****++++++**++*++++**#**#*++=======++====###***
***********==--:-====::----*%@@@@@@+=:::-==+=**##%%%%@@@%*-=%@@@@@*====+#%###*****++++++++++++*********+==+====++===+##***#
**+++++++++++==--====:::---+%@%%%%#%%%#-:-=+==+**#%#%@@@@%%%@@@@@@======#%%###******+*+************#***+==+====++===+#***##
+++++++++--+++==-====:::--=+%%%%%%#%@@@%=--==--++*###%%@@@@@@%@@@*-=====#%%%%###******************##***===+====++===*#**###
+++++++++-:-=+++=====-----+*%%##%%#%@@@@@+---=-=-=+**##%%@@@@@@%+:::-==+*%%%%%%######********#####*****===+====+++==*######
+++++++++-:::-=+=====-----:#%####**@@@@@@@*-----====-::-+++=-::-+++====++-#%%%%%%%%%%#################====+===+++=+*#######
+++++++++-::+-:-=====----+:-+*==++*@@@@@@@@#--====++*++**+++++***++==--*====---::---=+******+++**####+====+==++++++*#######
+++++++++-:-*=:-=====:---=******++*@@@@@@@@@#=====+++*@@%####*+======::::-+=====++************#**###*-======+==+++=########
+++++++++-:-*+:-=====:---=*####@*+*@@@@@@@@@@=+===++++*********#+====++**+==++*#%%%%%%%%%%%%#*+***##===========+++=########
+++++++++-:-*+:=======---*********+@@@@%%@@@%++====+++**********#*+++++=+++*%@@@@@@@@@@@%%#**+++++*====+=======++==*#######
+++++++++-:-++:=====--==-********++%@+=#@@@%+*=====++**++++++*****#*+****#@@@@@@@@@%#@@%%#*+=+++**+============++==*######*
+++++++++-:-++:=====-::---*#****+++**%+=*#**+=--=-=+++++++*##%%%@@%%%###%@@@@@@@@@%*%@%%#*++++***#=---=========++=+*#####*+
+++++++++-:-++:=====-::-----:--++==++**+--==-:-==-+++++=+#%%%%%@@@@@@@###@@@@@@@@%*#@@%##******##=-----===++===++=*######+=
+++++++++-:-++:=====--:----::---=-=-=+-::---::-=:-++=+=+#%%%%%%@@@@@@@#**#@@@@@@#**%@@%%##**####=------===++====++######*##
+++++++++=--++:=====--:-----:---:-::=--::::::--::-+==+=+##%%%%%@@@@@@@%***#@@@#****@@@@%%%####+=----=--===++====++#*==*=###
++++++++++=-----====--:----::--*-*#**#*#*+*#*+=***+--+-+#+#*##%@@@@@@@%******+*****-+#@@%%%#=--===--=--====+=====+##*+*##+*
++++++++++++++=-:-==--:-------*+#+:=%-:-##=:=%%==#*%%*##*#*##%%@@@@@@@@************::#:-*=------==--=+-====+====++++*##**#%
+++++++++++++++++-:=--:----:--==+==+=--=**--=*+-=##=+%+#*#+##*@@@@@@@@@*+*********%%*-:%--------==--==-====+=====*###%%#+#%
+++++++++++++++++=-=:-:----:-++++++++===*===+*+=+**++*+*****#*%@@@@@@@%*+********%%:::==--=*=---==--=--====+*##*+*#**#%%###
++++++++++++++++++---::----::-*%*%%%@#%#%%:::::=+:=++**==@@@@@@@@@@@@@%*+********%@+:-#--#--*---===-=--==-*#%%%%###%%#%#:==
*++==+++++++++++++---:::---:---:::::::::::::::::::::::::+@@@@@@@@@@@@@%+*****++**%@@%-+=*-------===-=:::-+%#%%#####*#*-==+*
-::::-=++++++++++++=-----:-:---:::::::::::::::::::::::::#@@@@@@@@@@@@@#+*****++**%%%%#*#+--=-=--==-=---:-%%%#%####**=+*#***
=+++:::=*++==++++++++=====--::--::::::::::::::::@::::::-%@@@@@@@@@@@@@*+***+++++*%@@@%+#*=*=-#==+::===-+#%%##%%#***********
:-**++-::=+==+++++++++--==-------::::::::::::::*%+::-=-%@@@@@@@@@@@@@#=+***++++**#@@%%#++++-+#%#==+=--+%######***#*#***+***
-::---++-=======++++++=====--:::::::::::::#%%@%%@@**#@@@@@@@@%##+%@@#+=****++++***@@@+*====#=#%#-*#**#######*****###***+***
=----=--+===+=======++======--::--+#+#%-::%@@@%%@%*#%=+#++**+#*%**%**=****++******%@@@%%###%%%##%%%##########*#%%%##***##*#
***=---+=-=-++++++=======-::::-=-+***+***#**#+++##+*%**%*+*#*%###+++-+***+++******@@@@@%%%%%%%%%%@@%##%###***####*#***#####
**+*=-===---+=+**+========----==--**#*##*%**%#**%%**%%**##%*+++=====+***++++******%@@@@%%%%%@%@@@%%%#####*=++**+++#**######
++**++++===+==*=++++++==---:::---=#*##%*%%#%#*%%=+===++*++*#====--=+*************%%@@@%@%%%%@%%###****##+==**====+#*#######
****++++++++=-======+=+++++=++=---***#*##*#**#**++***++===--+--==++************#%@%@@@#%%%%%#####%#####*+=-=*++=+++*#######
%##*#*++==-:-=---+=--:-==++=:----:=****#***#****+++++*++=====+++++********###%@@@%#@%%#%%%%#%#######*#**#*++++*++**########
%#*****#**==-:::-------::-::::::::-*****#********++++++++++++*+++******#%@@@@%%@%%%%%##%%%%%%###***#**+=-===+***++*#%##**#%
****+++#***++=++-::::-:-::::-:::::-+**++*++++****++++++++++++*+****##@@@@@@@%@%%%%%%%%#%%%@%##******++===++****#**###%#***#
==-:-==+##******#++----:-:-:::::::=+++=+=====++++++++++++++++***##%@@@@@@@@@@%%%%%%%%%%%%#*###*=+**+=====*+****######%%*#+*
*####=---+=-=#*####-:-:::::::::::=++==++==---===+++++++++++*###%@@@@@@@@@@@@%%%%%%%%%%###**##+==*++=+=+*+==+*####%#*==*####
--------=-===-=-::+=::::::::-+*#*+++**#*++===--===+++==++**#%@@@@@@@@@@@%%%%%%%%%%**#######*+=*###======+*####%%%%*###-*%%%
-::::::::::::::::::::::::-=*+**##*##%%%%##***++====+++*##%@@@@@@@@@@%%%%####%#####*##*###***+#=:::::::--+**#*##%%%%%%%+=+%%
:::::======-::-::::::::--++*#######%@@@@@@@@%%#####%%%@@@@@@@@@%%%###########+*#####*******##=---=****=+*****#####*=---++*+
=---*##*+++=----==++********######%@@@@@@@@@@@@@@@@@@@@@@%%%#####*********************+*++===***###########*#**---:--++++++
::::::::-=++++++******************#*########%%%%####******************************+=---=+#%+=**#########%+++=----::-=++*++*
=--::--=++++++***********************************************************+==---------===-==++##%%%%%%%#*+=-:::::::-*****+++
+++=-+=::------=+++*++++++*++++***********************+***+***********++==---------**=====+*++***#+:::--:::------**#**##**+
::-*##*+=:--=-----++++++*++++++++++++++++++++++++++++++*+++++==----::--=----------#*=-------=--+==##*=::::::::-+*++++*++***
-+#####*==-:::-------------------====+++++++++====------:::::::------:-------=::=---------###*==--------::-:-+***#*++****##
########**=-:::::----::::::::::::-::-::::-::::::::::::---:::=::::::::::::::::-:::::-------=+++=-===+=-==+**######*##*++*+**
###########*+-:::::::-:::::--+++--:::::::::::::::::::::::-:::::-:+*++--:-===--+--------=---------+-+###############**+*++**
#############*---::::::::::::::::::::::::--:::::::::::::::------=***###%%%%%*-----=--=---=-:-===**####################*++=+
##############*---::::::::::---=+=::::::::::::::::::::::--:::----=+***+==-----------------=++=--+#%%%%%#########%%%%%%#####
###############*=::--:::::::=***#*+--:::::::::::::::::::=-::::-:--::::::--::::::::----#+##%%%++=+%%%%%%%%%%%#%%%%%%%%%%%%%%
################*+=-:-:::::::-******=-:-:::-:::::-::::::::::::::::::::---#+==+===+*=------------=*####%%%%%%%%%%%%%%#**%##*
#############*#*#####+-::-=#*+=*######++-----------::::::::::::::::::::----------------+++=####+-===+*###############*++*==
############**##########*+--==+=#%%%%##*---***+---=----:-::::--:-:::::::::::----::-+*=----------------=+********+=::-======
#########***##############+**==+===+===---=+=----+=-+-------:::::----------------:-------------------------=++--=####+----=
##############%%%#############+==-------------=---=+#*+=-----:::::--::-:--::-:::::-::::::-:::---------:--------------------
*/

/*
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    CAR-NOVA.i // HIDDEN RELIC 01 â€” â€œSTARFLARE GATEâ€

    There is a URL encoded below in two layers.
    1) Take the hex bytes and convert to ASCII  â†’ base64 string
    2) Take that base64 string and decode       â†’ final URL
    3) Open the gate.

    Hex payload:
    61 48 52 30 63 48 4d 36 4c 79 39 35 62 33 56 30
    64 53 35 69 5a 53 39 6b 55 58 63 30 64 7a 6c 58
    5a 31 68 6a 55 51 3d 3d

    Hint for the worthy:
    â€¢ hex â†’ ASCII  â†’ base64 string
    â€¢ base64 â†’ ASCII  â†’ ????


    If you solved this, you have officially:
    â–¸ Looked under the hood
    â–¸ Spoke to the starflare
    â–¸ And joined CAR-NOVA.i in the void.
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
*/

